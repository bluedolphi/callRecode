# 任务002: 数据库设计和Room集成

## Metadata
- **Epic**: smart-call-recorder
- **Task ID**: 002
- **Created**: 2025-09-04T08:05:33Z
- **Status**: pending
- **Priority**: high
- **Estimated Hours**: 20
- **Parallelizable**: true
- **Dependencies**: []
- **Blocks**: [003]

## 概述
设计和实现智能通话录音助手的数据库架构，使用Room数据库框架，包含录音记录、上传配置和通话日志的完整数据存储方案。

## 目标
- [ ] Room数据库架构设计
- [ ] Entity实体类定义
- [ ] DAO接口实现
- [ ] Database类配置
- [ ] Repository模式实现

## 详细要求

### 1. 数据库架构设计
设计三个核心数据表：
- `recordings`: 录音记录表
- `upload_configs`: 上传配置表
- `call_logs`: 通话日志表

### 2. Entity实体类定义

#### RecordingEntity (recordings表)
```kotlin
@Entity(tableName = "recordings")
data class RecordingEntity(
    @PrimaryKey val id: String,
    val fileName: String,
    val filePath: String,
    val phoneNumber: String,
    val contactName: String?,
    val startTime: Long,
    val endTime: Long,
    val duration: Long,
    val fileSize: Long,
    val quality: String, // "STANDARD", "HIGH"
    val recordingMode: String, // "AUTO", "MANUAL"
    val isUploaded: Boolean = false,
    val uploadTime: Long? = null,
    val createdAt: Long,
    val updatedAt: Long
)
```

#### UploadConfigEntity (upload_configs表)
```kotlin
@Entity(tableName = "upload_configs")
data class UploadConfigEntity(
    @PrimaryKey val id: String,
    val serverUrl: String,
    val apiKey: String,
    val uploadEnabled: Boolean = true,
    val autoUpload: Boolean = false,
    val wifiOnly: Boolean = true,
    val compressionEnabled: Boolean = true,
    val retryAttempts: Int = 3,
    val createdAt: Long,
    val updatedAt: Long
)
```

#### CallLogEntity (call_logs表)
```kotlin
@Entity(tableName = "call_logs")
data class CallLogEntity(
    @PrimaryKey val id: String,
    val phoneNumber: String,
    val contactName: String?,
    val callType: String, // "INCOMING", "OUTGOING", "MISSED"
    val startTime: Long,
    val endTime: Long?,
    val duration: Long,
    val isRecorded: Boolean = false,
    val recordingId: String?,
    val createdAt: Long
)
```

### 3. DAO接口实现

#### RecordingDao
```kotlin
@Dao
interface RecordingDao {
    @Query("SELECT * FROM recordings ORDER BY startTime DESC")
    fun getAllRecordings(): Flow<List<RecordingEntity>>
    
    @Query("SELECT * FROM recordings WHERE id = :id")
    suspend fun getRecordingById(id: String): RecordingEntity?
    
    @Query("SELECT * FROM recordings WHERE phoneNumber = :phoneNumber ORDER BY startTime DESC")
    suspend fun getRecordingsByPhone(phoneNumber: String): List<RecordingEntity>
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertRecording(recording: RecordingEntity)
    
    @Update
    suspend fun updateRecording(recording: RecordingEntity)
    
    @Delete
    suspend fun deleteRecording(recording: RecordingEntity)
    
    @Query("DELETE FROM recordings WHERE id = :id")
    suspend fun deleteRecordingById(id: String)
    
    @Query("SELECT * FROM recordings WHERE isUploaded = 0")
    suspend fun getUnuploadedRecordings(): List<RecordingEntity>
}
```

#### UploadConfigDao
```kotlin
@Dao
interface UploadConfigDao {
    @Query("SELECT * FROM upload_configs LIMIT 1")
    suspend fun getUploadConfig(): UploadConfigEntity?
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertOrUpdateConfig(config: UploadConfigEntity)
    
    @Query("DELETE FROM upload_configs")
    suspend fun clearConfigs()
}
```

#### CallLogDao
```kotlin
@Dao
interface CallLogDao {
    @Query("SELECT * FROM call_logs ORDER BY startTime DESC LIMIT :limit")
    fun getRecentCallLogs(limit: Int = 100): Flow<List<CallLogEntity>>
    
    @Query("SELECT * FROM call_logs WHERE phoneNumber = :phoneNumber ORDER BY startTime DESC")
    suspend fun getCallLogsByPhone(phoneNumber: String): List<CallLogEntity>
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertCallLog(callLog: CallLogEntity)
    
    @Query("DELETE FROM call_logs WHERE startTime < :timestamp")
    suspend fun deleteOldCallLogs(timestamp: Long)
}
```

### 4. Database类配置
```kotlin
@Database(
    entities = [RecordingEntity::class, UploadConfigEntity::class, CallLogEntity::class],
    version = 1,
    exportSchema = false
)
@TypeConverters(Converters::class)
abstract class CallRecordDatabase : RoomDatabase() {
    abstract fun recordingDao(): RecordingDao
    abstract fun uploadConfigDao(): UploadConfigDao
    abstract fun callLogDao(): CallLogDao
}
```

### 5. Repository模式实现
- RecordingRepository: 录音数据访问层
- UploadConfigRepository: 配置数据访问层
- CallLogRepository: 通话记录数据访问层

## 验收标准
- [ ] 所有Entity类正确定义，包含必要字段和注解
- [ ] DAO接口完整实现，包含基础CRUD操作
- [ ] Database类正确配置，版本管理清晰
- [ ] Repository类实现完整，提供统一数据访问接口
- [ ] 数据库迁移策略设计完善
- [ ] 单元测试覆盖核心数据操作

## 技术规格
- **Room版本**: 最新稳定版
- **数据库版本**: v1
- **字符编码**: UTF-8
- **日期存储**: Unix时间戳（Long类型）

## 风险和注意事项
- 确保数据库字段设计支持未来扩展
- 注意大文件路径存储的字符长度限制
- 考虑数据库查询性能，适当添加索引
- 实现数据备份和恢复机制

## 测试计划
- [ ] Entity类序列化测试
- [ ] DAO操作单元测试
- [ ] Database初始化测试
- [ ] Repository数据访问测试
- [ ] 并发访问安全性测试

## 相关文件
- `data/database/entity/`目录下的Entity类
- `data/database/dao/`目录下的DAO接口
- `data/database/CallRecordDatabase.kt`
- `data/repository/`目录下的Repository类

## 备注
数据库设计需要考虑性能和扩展性，为后续功能开发提供稳定的数据存储基础。特别关注录音文件的元数据存储和查询优化。