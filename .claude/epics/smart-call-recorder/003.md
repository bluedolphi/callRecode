# 任务003: 录音核心引擎开发

## Metadata
- **Epic**: smart-call-recorder
- **Task ID**: 003
- **Created**: 2025-09-04T08:05:33Z
- **Status**: pending
- **Priority**: critical
- **Estimated Hours**: 28
- **Parallelizable**: false
- **Dependencies**: [001]
- **Blocks**: []

## 概述
开发智能通话录音助手的核心录音引擎，实现电话状态监听、自动/手动录音模式管理、陌生号码录音询问机制、录音质量预设等核心功能。

## 目标
- [ ] TelephonyManager电话状态监听
- [ ] MediaRecorder录音实现
- [ ] 录音模式管理（自动/手动）
- [ ] 陌生号码录音询问机制
- [ ] 录音质量预设（标准/高质量）
- [ ] 录音文件管理和存储

## 详细要求

### 1. 电话状态监听系统

#### PhoneStateListener实现
```kotlin
class CallRecordingPhoneStateListener(
    private val recordingEngine: RecordingEngine
) : PhoneStateListener() {
    
    override fun onCallStateChanged(state: Int, phoneNumber: String?) {
        when (state) {
            TelephonyManager.CALL_STATE_RINGING -> {
                // 来电响铃状态
                recordingEngine.onIncomingCall(phoneNumber)
            }
            TelephonyManager.CALL_STATE_OFFHOOK -> {
                // 通话中状态
                recordingEngine.onCallStarted(phoneNumber)
            }
            TelephonyManager.CALL_STATE_IDLE -> {
                // 通话结束状态
                recordingEngine.onCallEnded()
            }
        }
    }
}
```

### 2. 录音核心引擎

#### RecordingEngine核心类
```kotlin
class RecordingEngine(
    private val context: Context,
    private val recordingRepository: RecordingRepository,
    private val callLogRepository: CallLogRepository
) {
    
    private var mediaRecorder: MediaRecorder? = null
    private var currentRecording: RecordingSession? = null
    private val recordingMode: RecordingMode = getRecordingMode()
    private val recordingQuality: RecordingQuality = getRecordingQuality()
    
    // 核心录音方法
    suspend fun startRecording(phoneNumber: String?, isManual: Boolean = false)
    suspend fun stopRecording()
    suspend fun pauseRecording()
    suspend fun resumeRecording()
    
    // 录音模式管理
    fun setRecordingMode(mode: RecordingMode)
    fun getRecordingMode(): RecordingMode
    
    // 录音质量管理
    fun setRecordingQuality(quality: RecordingQuality)
    fun getRecordingQuality(): RecordingQuality
}
```

### 3. 录音模式管理

#### 自动录音模式
- 检测到通话开始时自动开始录音
- 支持白名单/黑名单过滤
- 陌生号码录音询问机制

#### 手动录音模式
- 用户主动触发录音开始/停止
- 录音按钮状态管理
- 录音进度实时显示

```kotlin
enum class RecordingMode {
    AUTO,           // 自动录音
    MANUAL,         // 手动录音
    ASK_UNKNOWN     // 陌生号码询问
}

class RecordingModeManager {
    fun shouldAutoRecord(phoneNumber: String?): Boolean {
        return when (getCurrentMode()) {
            RecordingMode.AUTO -> true
            RecordingMode.MANUAL -> false
            RecordingMode.ASK_UNKNOWN -> !isKnownContact(phoneNumber)
        }
    }
    
    private fun isKnownContact(phoneNumber: String?): Boolean {
        // 检查联系人数据库
        return contactRepository.isKnownNumber(phoneNumber)
    }
}
```

### 4. 陌生号码录音询问机制

#### 询问弹窗实现
```kotlin
class UnknownNumberRecordingDialog {
    
    fun showRecordingPrompt(
        phoneNumber: String,
        onConfirm: () -> Unit,
        onDeny: () -> Unit,
        onRemember: (shouldRemember: Boolean) -> Unit
    ) {
        // 显示录音询问对话框
        // - "开始录音"按钮
        // - "拒绝录音"按钮  
        // - "记住选择"复选框
    }
    
    // 自动消失计时器（10秒）
    private fun startAutoCloseTimer()
}
```

### 5. 录音质量预设

#### 录音质量配置
```kotlin
enum class RecordingQuality(
    val sampleRate: Int,
    val bitRate: Int,
    val channels: Int,
    val format: Int
) {
    STANDARD(
        sampleRate = 8000,
        bitRate = 12200,
        channels = 1,
        format = MediaRecorder.OutputFormat.AMR_NB
    ),
    HIGH(
        sampleRate = 44100,
        bitRate = 128000,
        channels = 2,
        format = MediaRecorder.OutputFormat.MPEG_4
    )
}

class AudioQualityManager {
    fun configureRecorder(
        recorder: MediaRecorder,
        quality: RecordingQuality
    ) {
        recorder.apply {
            setAudioSamplingRate(quality.sampleRate)
            setAudioEncodingBitRate(quality.bitRate)
            setAudioChannels(quality.channels)
            setOutputFormat(quality.format)
        }
    }
}
```

### 6. 录音会话管理

#### RecordingSession数据类
```kotlin
data class RecordingSession(
    val id: String,
    val phoneNumber: String?,
    val contactName: String?,
    val startTime: Long,
    val filePath: String,
    val quality: RecordingQuality,
    val mode: RecordingMode,
    var status: RecordingStatus = RecordingStatus.RECORDING
)

enum class RecordingStatus {
    RECORDING,
    PAUSED,
    STOPPED,
    ERROR
}
```

### 7. 文件存储和管理

#### 录音文件命名规则
格式：`{timestamp}_{phoneNumber}_{duration}.{extension}`
示例：`20250904_1234567890_120s.m4a`

#### 存储路径管理
```kotlin
class RecordingFileManager {
    
    private val recordingDir = File(context.getExternalFilesDir(null), "recordings")
    
    fun generateFileName(phoneNumber: String?, startTime: Long): String {
        val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault())
            .format(Date(startTime))
        val phone = phoneNumber?.replace("[^0-9]".toRegex(), "") ?: "unknown"
        return "${timestamp}_${phone}.m4a"
    }
    
    fun getRecordingFile(fileName: String): File {
        return File(recordingDir, fileName)
    }
    
    fun cleanupOldRecordings(daysToKeep: Int = 30) {
        // 清理超过指定天数的录音文件
    }
}
```

## 验收标准
- [ ] 电话状态监听准确响应通话状态变化
- [ ] 自动录音模式工作正常，支持白名单/黑名单
- [ ] 手动录音模式支持用户主动控制
- [ ] 陌生号码询问机制正确弹出对话框
- [ ] 录音质量预设切换正常，音质符合预期
- [ ] 录音文件正确保存，文件名规范
- [ ] 录音过程无异常中断，错误处理完善

## 技术规格
- **录音格式**: M4A (AAC编码)
- **标准质量**: 8kHz, 12.2kbps, 单声道
- **高质量**: 44.1kHz, 128kbps, 双声道
- **最大单次录音时长**: 4小时
- **文件存储位置**: 应用私有目录

## 风险和注意事项
- Android不同版本的录音API兼容性
- 部分厂商ROM对通话录音的限制
- 录音权限的动态申请和处理
- 大文件录音时的内存管理
- 通话过程中应用被杀死的处理

## 测试计划
- [ ] 各种通话场景录音测试（来电、去电、会议电话）
- [ ] 录音模式切换测试
- [ ] 录音质量对比测试
- [ ] 陌生号码询问流程测试
- [ ] 长时间录音稳定性测试
- [ ] 异常情况处理测试（权限拒绝、存储空间不足等）

## 相关文件
- `recording/RecordingEngine.kt`
- `recording/PhoneStateListener.kt`
- `recording/RecordingModeManager.kt`
- `recording/AudioQualityManager.kt`
- `recording/RecordingFileManager.kt`
- `ui/recording/RecordingControlFragment.kt`

## 备注
录音功能是应用的核心，需要特别关注在不同Android版本和设备上的兼容性。陌生号码录音询问机制要考虑用户体验，避免过于频繁的打扰。